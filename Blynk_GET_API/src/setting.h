#include <Wire.h>        // 引入I2C库
#include "SSD1306Wire.h" // 引入OLED驱动库

void get_v0(); // 获取第一个请求
void get_v1(); // 获取第二个请求
void get_v2(); // 获取第三个请求
void get_v3(); // 获取第四个请求

void draw_countdown(); // 定义函数，用于绘制倒计时界面
void draw_info();      // 定义函数，用于绘制信息界面
void draw_note();      // 定义函数，用于绘制提示信息界面
void draw_done();      // 定义函数，用于绘制完成界面



// 用于WiFiManager界面中的变量服务器域名、端口、口令
std::string blynk_server;
std::string blynk_port;
std::string blynk_token;

const int SetPin = D3;

bool shouldSaveConfig = false;

String pin_v0 = "V0"; // 传感器V0引脚标识符
String pin_v1 = "V1"; // 传感器V1引脚标识符
String pin_v2 = "V2"; // 传感器V2引脚标识符
String pin_v3 = "V3"; // 传感器V3引脚标识符

// 初始化OLED对象
SSD1306Wire display(0x3c, D2, D1);

// 定义Wi-Fi图标的数组
const uint8_t wifi_logo[] PROGMEM = {
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xFF, 0x07, 0x00, 0x00, 0x00,
  0x00, 0x00, 0xE0, 0xFF, 0x1F, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0xFF,
  0x7F, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC, 0xFF, 0xFF, 0x00, 0x00, 0x00,
  0x00, 0x00, 0xFE, 0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00, 0x00, 0xFF, 0xFF,
  0xFF, 0x03, 0x00, 0x00, 0x00, 0xFC, 0xFF, 0xFF, 0xFF, 0xFF, 0x00, 0x00,
  0x00, 0xFF, 0xFF, 0xFF, 0x07, 0xC0, 0x83, 0x01, 0x80, 0xFF, 0xFF, 0xFF,
  0x01, 0x00, 0x07, 0x00, 0xC0, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x0C, 0x00,
  0xC0, 0xFF, 0xFF, 0x7C, 0x00, 0x60, 0x0C, 0x00, 0xC0, 0x31, 0x46, 0x7C,
  0xFC, 0x77, 0x08, 0x00, 0xE0, 0x23, 0xC6, 0x3C, 0xFC, 0x67, 0x18, 0x00,
  0xE0, 0x23, 0xE4, 0x3F, 0x1C, 0x00, 0x18, 0x00, 0xE0, 0x23, 0x60, 0x3C,
  0x1C, 0x70, 0x18, 0x00, 0xE0, 0x03, 0x60, 0x3C, 0x1C, 0x70, 0x18, 0x00,
  0xE0, 0x07, 0x60, 0x3C, 0xFC, 0x73, 0x18, 0x00, 0xE0, 0x87, 0x70, 0x3C,
  0xFC, 0x73, 0x18, 0x00, 0xE0, 0x87, 0x70, 0x3C, 0x1C, 0x70, 0x18, 0x00,
  0xE0, 0x87, 0x70, 0x3C, 0x1C, 0x70, 0x18, 0x00, 0xE0, 0x8F, 0x71, 0x3C,
  0x1C, 0x70, 0x18, 0x00, 0xC0, 0xFF, 0xFF, 0x3F, 0x00, 0x00, 0x08, 0x00,
  0xC0, 0xFF, 0xFF, 0x1F, 0x00, 0x00, 0x0C, 0x00, 0x80, 0xFF, 0xFF, 0x1F,
  0x00, 0x00, 0x06, 0x00, 0x80, 0xFF, 0xFF, 0x0F, 0x00, 0x00, 0x07, 0x00,
  0x00, 0xFE, 0xFF, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0x00, 0xF8, 0xFF, 0xFF,
  0xFF, 0x7F, 0x00, 0x00, 0x00, 0x00, 0xFE, 0xFF, 0xFF, 0x01, 0x00, 0x00,
  0x00, 0x00, 0xFC, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF8, 0xFF,
  0x7F, 0x00, 0x00, 0x00, 0x00, 0x00, 0xE0, 0xFF, 0x1F, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x80, 0xFF, 0x07, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFC,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
};

void draw_info(){
  display.clear();                           // 清空屏幕
  display.setTextAlignment(TEXT_ALIGN_LEFT); // 文字居左对齐
  display.drawXbm(35, 0, 60, 36, wifi_logo); // 在屏幕上绘制WiFi图标
  display.drawString(0, 40,"IP: " +String(WiFi.localIP().toString()));
  display.display();                         // 显示WiFi图标
  delay(3000);
}

void draw_countdown(){
    display.setFont(ArialMT_Plain_16); // 设置显示字体
    display.clear(); // 清空显示器上的内容
    display.drawString(5, 25, "Reboot in 5 Sec !"); // 在显示器上显示倒计时信息
    display.display(); // 将内容显示到显示器上
    delay(1000); // 程序暂停1秒钟

    display.clear();
    display.drawString(5, 25, "Reboot in 4 Sec !");
    display.display();
    delay(1000);

    display.clear();
    display.drawString(5, 25, "Reboot in 3 Sec !");
    display.display();
    delay(1000);

    display.clear();
    display.drawString(5, 25, "Reboot in 2 Sec !");
    display.display();
    delay(1000);

    display.clear();
    display.drawString(5, 25, "Reboot in 1 Sec !");
    display.display();
    delay(1000);
}


void draw_note(){    
    display.clear(); // 清空屏幕
    display.drawXbm(35, 0, 60, 36, wifi_logo); // 在屏幕上绘制WiFi图标
    display.setFont(ArialMT_Plain_16); // 设置字体大小
    display.drawString(33, 35, "AP Mode"); // 在屏幕上绘制"AP Mode"文字
    display.setFont(ArialMT_Plain_10); // 设置字体大小
    display.drawString(17, 50, "waiting for config WiFi"); // 在屏幕上绘制"waiting for config WiFi"文字
    display.display(); // 刷新屏幕
    delay(1000); // 延迟1秒
}

void draw_done(){    
    display.clear(); // 清空屏幕
    display.drawXbm(35, 0, 60, 36, wifi_logo); // 在屏幕上绘制WiFi图标
    display.setFont(ArialMT_Plain_16); // 设置字体大小
    display.drawString(45, 35, "Dnoe"); // 在屏幕上绘制"Dnoe"文字
    display.setFont(ArialMT_Plain_10); // 设置字体大小
    display.drawString(17, 50, "reboot for connet WiFi"); // 在屏幕上绘制"reboot for connet WiFi"文字
    display.display(); // 刷新屏幕
    delay(1000); // 延迟1秒
}